FROM node:20-slim

# Install runtime/build deps (glibc environment fixes esbuild EPIPE issues)
RUN apt-get update && apt-get install -y --no-install-recommends \
  curl git bash python3 build-essential ca-certificates \
  && rm -rf /var/lib/apt/lists/*

# uv (optional) - copy binaries
COPY --from=ghcr.io/astral-sh/uv:0.6.13 /uv /uvx /usr/local/bin/

RUN corepack enable
RUN npm install -g nodemon cross-env concurrently

WORKDIR /app

# Replace full copy with manifest-only for layer cache
# (Source is bind-mounted at runtime)
COPY --chown=node:node ../package.json ./
COPY --chown=node:node ../package-lock.json ./

# Add workspace manifests for deterministic cached installs
COPY --chown=node:node ../api/package.json ./api/package.json
COPY --chown=node:node ../client/package.json ./client/package.json

ARG NODE_ENV=development
ENV NODE_ENV=$NODE_ENV HOST=0.0.0.0

RUN npm config set fetch-retry-maxtimeout 600000 \
 && npm config set fetch-retries 5 \
 && npm config set fetch-retry-mintimeout 15000 \
 && npm ci --include=optional --no-audit --no-fund --workspaces

EXPOSE 3080 3090 3000

